let POKEMON_DATA=[]
fetch('pokemon_data.json').then(res=>res.json()).then(data=>{POKEMON_DATA=data})
const BIOMES=[{name:'Lush Jungle',type:'jungle',color:'bg-green-700',icon:'fas fa-tree',text:'text-green-200',allowedTypes:['grass','bug','fairy']},{name:'Sandy Beach',type:'water',color:'bg-blue-500',icon:'fas fa-anchor',text:'text-blue-100',allowedTypes:['water','ice']},{name:'Volcano Park',type:'desert',color:'bg-red-800',icon:'fas fa-fire',text:'text-red-200',allowedTypes:['fire','rock','ground'],noPokecenter:true},{name:'Spooky Caves',type:'cave',color:'bg-gray-700',icon:'fas fa-mountain',text:'text-gray-200',allowedTypes:['ghost','dark','dragon'],noPokecenter:true},{name:'Hau\'oli City',type:'city',color:'bg-indigo-600',icon:'fas fa-city',text:'text-indigo-200',allowedTypes:['normal','electric','steel','psychic']}]
let status='paused'
let currentBiome=BIOMES[0]
let disabledBiomes={}
let encounterPokemon=null
let isPokecenterVisible=false
let biomeTimer=null
let encounterTimer=null
let pokecenterTimer=null
let pokecenterVisibilityTimer=null
const getRandomTime=(min,max)=>Math.floor(Math.random()*(max-min+1))+min
const calculateNextBiomeTime=()=>getRandomTime(100,500)*1000
const calculateNextEncounterTime=()=>getRandomTime(15,30)*1000
const calculateNextPokecenterTime=()=>getRandomTime(300,900)*1000
const clearAllTimers=()=>{clearTimeout(biomeTimer);clearTimeout(encounterTimer);clearTimeout(pokecenterTimer);clearTimeout(pokecenterVisibilityTimer)}
const updateStatusDisplay=()=>{const display=document.getElementById('status-display');const button=document.getElementById('play-pause-btn');const buttonText=document.getElementById('play-pause-text');const walker=document.getElementById('walker');display.className='';button.className='w-full py-3 rounded-xl font-bold text-lg transition duration-200 shadow-md transform hover:scale-[1.01]';button.disabled=false;switch(status){case'running':display.innerHTML='<i class="fas fa-play mr-1"></i> RUNNING';display.classList.add('text-green-500');buttonText.innerHTML='<i class="fas fa-pause mr-2"></i> Pause';button.classList.add('bg-yellow-500','hover:bg-yellow-600');walker.classList.add('animate-walk');break;case'paused':display.innerHTML='<i class="fas fa-pause mr-1"></i> PAUSED';display.classList.add('text-yellow-500');buttonText.innerHTML='<i class="fas fa-play mr-2"></i> Start/Resume';button.classList.add('bg-green-500','hover:bg-green-600');walker.classList.remove('animate-walk');break;case'encounter':display.innerHTML='<i class="fas fa-times mr-1"></i> ENCOUNTER';display.classList.add('text-red-500');button.disabled=true;button.classList.add('disabled:opacity-50','bg-yellow-500');buttonText.innerHTML='<i class="fas fa-pause mr-2"></i> Paused';walker.classList.remove('animate-walk');break;case'settings':display.innerHTML='<i class="fas fa-cog mr-1"></i> CONFIG';display.classList.add('text-blue-500');buttonText.innerHTML='<i class="fas fa-play mr-2"></i> Start/Resume';button.classList.add('bg-green-500','hover:bg-green-600');walker.classList.remove('animate-walk');break}}
const updateBiomeDisplay=(biome)=>{const container=document.getElementById('biome-container');const nameEl=document.getElementById('biome-name');const iconEl=document.getElementById('biome-icon');const infoEl=document.getElementById('biome-info');BIOMES.forEach(b=>container.classList.remove(b.color));container.classList.add(biome.color);nameEl.textContent=biome.name;iconEl.className=`${biome.icon} mr-2`;infoEl.innerHTML=`<span class="text-xl mr-2 ${biome.text}"><i class="${biome.icon}"></i></span> You are currently walking through the ${biome.name} biome.`}
const updatePokecenterVisibility=(isVisible)=>{const center=document.getElementById('pokecenter-icon');if(isVisible){center.classList.remove('opacity-0','translate-x-10','pointer-events-none');center.classList.add('opacity-100','translate-x-0')}else{center.classList.add('opacity-0','translate-x-10','pointer-events-none');center.classList.remove('opacity-100','translate-x-0')}isPokecenterVisible=isVisible}
function showEncounterModal(pokemon){const modal=document.getElementById('encounter-modal');const movesList=(pokemon.moves||[]).map(move=>`<li class="py-1 px-2 bg-indigo-50 rounded-md mb-1 text-gray-700 font-medium">${move}</li>`).join('');modal.innerHTML=`<div class="bg-white p-8 rounded-3xl shadow-2xl max-w-lg w-full border-4 border-yellow-400"><div class="text-center mb-6"><div class="text-6xl mb-2">âš¡</div><h2 class="text-4xl font-extrabold text-gray-900 mt-2">Wild <span class="text-indigo-600">${pokemon.name}</span> Appeared!</h2><p class="text-xl text-gray-500 mt-1 font-medium">Simulation Paused</p></div><div class="bg-gray-50 p-6 rounded-2xl border border-gray-200"><h3 class="text-2xl font-bold mb-3 text-gray-700 flex items-center"><i class="fas fa-heart mr-2 text-red-500"></i> HP</h3><p class="text-3xl font-extrabold text-red-600 text-center mb-4">${pokemon.hp}</p><h3 class="text-2xl font-bold mb-3 text-gray-700 flex items-center"><i class="fas fa-fist-raised mr-2 text-indigo-500"></i> Moves</h3><ul class="list-none">${movesList}</ul></div><div class="grid grid-cols-2 gap-4 mt-6"><button onclick="handleContinue()" class="py-4 px-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02]">Continue Journey</button><button onclick="handleReroll()" class="py-4 px-4 bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02]">Reroll Encounter</button></div></div>`;modal.classList.remove('hidden')}
function hideEncounterModal(){const modal=document.getElementById('encounter-modal');if(!modal)return;modal.classList.add('hidden');modal.innerHTML=''}
function handleReroll(){const pokemon=getRandomPokemonForBiome(currentBiome);if(!pokemon)return;encounterPokemon={name:pokemon.name,hp:pokemon.stats.hp,moves:pokemon.moves.map(m=>m[0])};showEncounterModal(encounterPokemon)}
const updateSettingsPane=()=>{const pane=document.getElementById('settings-pane');pane.classList.remove('hidden');const biomeList=BIOMES.map(biome=>`<label class="flex items-center p-3 rounded-xl cursor-pointer transition duration-150 border ${disabledBiomes[biome.name]?'bg-red-50 border-red-300 opacity-70':'bg-white border-green-300 shadow-sm hover:bg-green-50'}"><input type="checkbox" onchange="toggleBiomeDisabled('${biome.name}')" ${!disabledBiomes[biome.name]?'checked':''} class="mr-2 h-5 w-5 text-indigo-600 border-gray-300 rounded-lg focus:ring-indigo-500"/><span class="text-gray-800 flex items-center text-sm font-medium"><i class="${biome.icon} w-5 h-5 mr-2 text-indigo-500"></i><span class="ml-2">${biome.name}</span>${biome.noPokecenter?'<span class="ml-2 px-2 py-0.5 text-xs bg-red-500 text-white rounded-full">No PC</span>':''}</span></label>`).join('');pane.innerHTML=`<div class="p-4 bg-white rounded-xl shadow-lg mt-4 w-full border border-gray-100"><div class="flex justify-between items-center mb-3"><h3 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-cog w-5 h-5 mr-2"></i>Simulation Settings</h3><button onclick="toggleSettings()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200 transition"><i class="fas fa-times w-5 h-5"></i></button></div><div class="p-4 bg-gray-50 rounded-lg shadow-inner"><h4 class="text-lg font-semibold mb-2 text-gray-700 flex items-center"><i class="fas fa-layer-group w-5 h-5 mr-2 text-indigo-500"></i>Disable Biomes (Requires Reset)</h4><div class="grid grid-cols-2 gap-3">${biomeList}</div><p class="text-xs text-red-500 mt-3 font-medium text-center">You must click the "Reset" button for biome changes to take effect.</p></div></div>`}
function handleBiomeChange(){const availableBiomes=BIOMES.filter(biome=>!disabledBiomes[biome.name]&&biome.name!==currentBiome.name);if(availableBiomes.length===0){startTimers();return}const newBiome=availableBiomes[Math.floor(Math.random()*availableBiomes.length)];currentBiome=newBiome;updateBiomeDisplay(currentBiome);setTimeout(startTimers,1500)}
const getRandomPokemonForBiome=(biome)=>{const candidates=POKEMON_DATA.filter(p=>p.types.some(t=>biome.allowedTypes.includes(t)));if(candidates.length===0)return null;return candidates[Math.floor(Math.random()*candidates.length)]}
function handlePokecenterAppearance(){if(currentBiome.noPokecenter){pokecenterTimer=setTimeout(handlePokecenterAppearance,calculateNextPokecenterTime());return}updatePokecenterVisibility(true);pokecenterVisibilityTimer=setTimeout(()=>{updatePokecenterVisibility(false)},60000);pokecenterTimer=setTimeout(handlePokecenterAppearance,calculateNextPokecenterTime())}
function handleEncounter(){clearAllTimers();status='encounter';updateStatusDisplay();const pokemon=getRandomPokemonForBiome(currentBiome);if(!pokemon){startTimers();return}encounterPokemon={name:pokemon.name,hp:pokemon.stats.hp,moves:pokemon.moves.map(m=>m[0])};showEncounterModal(encounterPokemon);updatePokecenterVisibility(false)}
const startTimers=()=>{if(status==='running')return;clearAllTimers();status='running';updateStatusDisplay();biomeTimer=setTimeout(handleBiomeChange,calculateNextBiomeTime());const encounterDelay=Number(calculateNextEncounterTime());if(Number.isFinite(encounterDelay)){encounterTimer=setTimeout(handleEncounter,encounterDelay)}pokecenterTimer=setTimeout(handlePokecenterAppearance,calculateNextPokecenterTime())}
const pauseTimers=()=>{clearAllTimers();if(status!=='encounter'){status='paused';updateStatusDisplay()}}
window.togglePlayPause=()=>{if(status==='running'){pauseTimers()}else if(status==='paused'||status==='settings'){if(status==='settings')toggleSettings();startTimers()}}
window.toggleSettings=()=>{if(status==='settings'){status='paused';document.getElementById('settings-pane').classList.add('hidden');updateStatusDisplay()}else{pauseTimers();status='settings';updateStatusDisplay();updateSettingsPane()}}
window.toggleBiomeDisabled=(biomeName)=>{disabledBiomes[biomeName]=!disabledBiomes[biomeName];updateSettingsPane()}
window.handleContinue=()=>{hideEncounterModal();encounterPokemon=null;startTimers()}
window.handleReset=()=>{clearAllTimers();const availableBiomes=BIOMES.filter(biome=>!disabledBiomes[biome.name]);if(availableBiomes.length===0){currentBiome=BIOMES[0]}else{currentBiome=availableBiomes[Math.floor(Math.random()*availableBiomes.length)]}updateBiomeDisplay(currentBiome);hideEncounterModal();updatePokecenterVisibility(false);status='paused';setTimeout(startTimers,50)}
window.onload=()=>{handleReset()}
